<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet"> <!-- You can remove if only Courier New is used -->
  <link rel="stylesheet" href="/ticker.css">
</head>
<body>
  <button id="fullscreenBtn" class="fullscreen-button" onclick="toggleFullscreen()">Fullscreen</button>

  <div class="header-spacer"></div> <!-- Spacer to avoid overlapping background header -->

  <ul id="leaderboard" class="leaderboard-list"></ul>

  <script>
    let fullscreenButton = document.getElementById('fullscreenBtn');
    let currentPlayers = {}; 

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // Hide fullscreen button while in fullscreen
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        fullscreenButton.style.display = 'none';
      } else {
        fullscreenButton.style.display = 'block';
      }
    });

    function loadLeaderboard() {
      fetch('/api/players')
        .then(response => response.json())
        .then(players => {
          updateLeaderboard(players);
        });
    }

    function updateLeaderboard(players) {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '';

      const sortedPlayers = Object.entries(players)
        .sort(([, a], [, b]) => b.score - a.score); // Sort highest score first

      const topPlayerID = sortedPlayers.length > 0 ? sortedPlayers[0][0] : null;

      sortedPlayers.forEach(([id, player]) => {
        const row = document.createElement('li');

        if (!currentPlayers[id]) {
          row.classList.add('fade-in');
        }

        row.innerHTML = `
          <span class="player-name">${id === topPlayerID ? "ðŸ¥‡ " : ""}${player.name}</span>
          <span class="player-score" id="score-${id}">0</span>
        `;

        leaderboard.appendChild(row);

        // Animate the score counting up
        animateScore(`score-${id}`, currentPlayers[id]?.score || 0, player.score);
      });

      // Update current players memory
      currentPlayers = { ...players };
    }

    function animateScore(elementId, start, end) {
      const element = document.getElementById(elementId);
      const duration = 800; // milliseconds
      const frameRate = 60; // frames per second
      const totalFrames = Math.round(duration / (1000 / frameRate));
      let frame = 0;

      const counter = setInterval(() => {
        frame++;
        const progress = frame / totalFrames;
        const currentScore = Math.round(start + (end - start) * progress);
        element.innerText = currentScore;

        if (frame === totalFrames) {
          clearInterval(counter);
        }
      }, 1000 / frameRate);
    }

    window.addEventListener('load', loadLeaderboard);
    setInterval(loadLeaderboard, 3000); // Refresh leaderboard every 3 seconds
  </script>
</body>
</html>