<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaderboard</title>
  <link rel="stylesheet" href="/ticker.css">
</head>
<body>
  <button id="fullscreenBtn" class="fullscreen-button" onclick="toggleFullscreen()">Fullscreen</button>

  <div class="header-spacer"></div>

  <ul id="leaderboard" class="leaderboard-list"></ul>

  <script>
    let fullscreenButton = document.getElementById('fullscreenBtn');
    let currentPlayers = {};
    let autoScrollEnabled = false;
    let scrollIntervalId;

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        fullscreenButton.style.display = 'none';
      } else {
        fullscreenButton.style.display = 'block';
      }
    });

    function loadLeaderboard() {
      fetch('/api/players')
        .then(response => response.json())
        .then(players => {
          updateLeaderboard(players);
        });
    }

    function updateLeaderboard(players) {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '';

      const sortedPlayers = Object.entries(players)
        .sort(([, a], [, b]) => b.score - a.score);

      const topPlayerID = sortedPlayers.length > 0 ? sortedPlayers[0][0] : null;

      sortedPlayers.forEach(([id, player]) => {
        const row = document.createElement('li');

        if (!currentPlayers[id]) {
          row.classList.add('fade-in');
        }

        row.innerHTML = `
          <span class="player-name">${id === topPlayerID ? "ðŸ¥‡ " : ""}${player.name}</span>
          <span class="player-score" id="score-${id}">0</span>
        `;

        leaderboard.appendChild(row);

        animateScore(`score-${id}`, currentPlayers[id]?.score || 0, player.score);
      });

      currentPlayers = { ...players };

      if (sortedPlayers.length >= 5 && !autoScrollEnabled) {
        startAutoScroll();
      }
    }

    function animateScore(elementId, start, end) {
      const element = document.getElementById(elementId);
      const duration = 800;
      const frameRate = 60;
      const totalFrames = Math.round(duration / (1000 / frameRate));
      let frame = 0;

      const counter = setInterval(() => {
        frame++;
        const progress = frame / totalFrames;
        const currentScore = Math.round(start + (end - start) * progress);
        element.innerText = currentScore;

        if (frame === totalFrames) {
          clearInterval(counter);
        }
      }, 1000 / frameRate);
    }

    window.addEventListener('load', () => {
      loadLeaderboard();
    });
    setInterval(loadLeaderboard, 3000);

    // ==========================
    // AUTOSCROLL BELOW
    // ==========================

    function startAutoScroll() {
      autoScrollEnabled = true;
      const scrollSpeed = 1; // pixels per frame
      const scrollInterval = 30; // how often to scroll (lower = smoother)
      const pauseAtEnd = 3000; // pause at bottom before reset (ms)

      scrollIntervalId = setInterval(() => {
        if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight) {
          clearInterval(scrollIntervalId);
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'instant' });
            setTimeout(() => {
              scrollIntervalId = setInterval(autoScrollStep, scrollInterval);
            }, 1000); // small pause at top again
          }, pauseAtEnd);
        } else {
          window.scrollBy(0, scrollSpeed);
        }
      }, scrollInterval);
    }

    function autoScrollStep() {
      window.scrollBy(0, 1);
    }
  </script>
</body>
</html>