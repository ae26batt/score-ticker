<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaderboard</title>
  <link rel="stylesheet" href="/ticker.css">
</head>
<body>
  <button id="fullscreenBtn" class="fullscreen-button" onclick="toggleFullscreen()">Fullscreen</button>

  <div class="header-spacer"></div>

  <ul id="leaderboard" class="leaderboard-list"></ul>

  <script>
    let fullscreenButton = document.getElementById('fullscreenBtn');
    let playersData = [];
    let currentIndex = 0;
    const HEADER_HEIGHT = 200;
    const DISPLAY_COUNT = 5; // how many players show at once
    const UPDATE_INTERVAL = 3000; // ms between changing players

    async function loadPlayers() {
      const response = await fetch('/api/players');
      const data = await response.json();
      playersData = Object.entries(data)
        .sort(([, a], [, b]) => b.score - a.score)
        .map(([id, player]) => ({ id, ...player }));

      renderPlayers();
    }

    function renderPlayers() {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '';

      const totalPlayers = playersData.length;
      if (totalPlayers === 0) return;

      for (let i = 0; i < Math.min(DISPLAY_COUNT, totalPlayers); i++) {
        const playerIndex = (currentIndex + i) % totalPlayers;
        const player = playersData[playerIndex];

        const li = document.createElement('li');
        li.innerHTML = `
          <span class="player-name">${player.name}</span>
          <span class="player-score">${player.score}</span>
        `;
        leaderboard.appendChild(li);
      }
    }

    function cyclePlayers() {
      if (playersData.length > DISPLAY_COUNT) {
        currentIndex = (currentIndex + 1) % playersData.length;
        renderPlayers();
      }
    }

    async function start() {
      await loadPlayers();
      setInterval(cyclePlayers, UPDATE_INTERVAL);
      setInterval(loadPlayers, 5000); // refresh player list from server every 5s
    }

    // Auto fullscreen
    async function requestFullscreen() {
      try {
        await document.documentElement.requestFullscreen();
      } catch (err) {
        console.log('Fullscreen error:', err);
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    window.addEventListener('load', () => {
      window.scrollTo({ top: HEADER_HEIGHT });
      requestFullscreen();
      start();
    });

    window.addEventListener('scroll', () => {
      if (window.scrollY < HEADER_HEIGHT) {
        window.scrollTo({ top: HEADER_HEIGHT });
      }
    });

    document.addEventListener('fullscreenchange', () => {
      fullscreenButton.style.display = document.fullscreenElement ? 'none' : 'block';
    });
  </script>
</body>
</html>